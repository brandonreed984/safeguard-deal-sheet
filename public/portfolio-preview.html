<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Review Preview</title>
  <script src="./auth-check.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .controls {
      max-width: 8.5in;
      margin: 0 auto 20px;
      display: flex;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-back {
      background: #6c757d;
      color: white;
    }
    
    .btn-generate {
      background: #28a745;
      color: white;
    }
    
    .preview-container {
      max-width: 8.5in;
      margin: 0 auto;
      background: white;
      padding: 0.5in;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #1E66B4;
    }
    
    .logo {
      height: 80px;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #1E66B4;
      font-size: 28pt;
      margin-bottom: 5px;
    }
    
    .investor-name {
      font-size: 20pt;
      color: #333;
      font-weight: 600;
    }
    
    .summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 2px solid #1E66B4;
    }
    
    .summary h2 {
      color: #1E66B4;
      font-size: 18pt;
      margin-bottom: 15px;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
    }
    
    .summary-item {
      text-align: center;
    }
    
    .summary-label {
      font-size: 11pt;
      color: #666;
      margin-bottom: 5px;
    }
    
    .summary-value {
      font-size: 20pt;
      font-weight: bold;
      color: #1E66B4;
    }
    
    .section {
      margin-bottom: 40px;
    }
    
    .section h2 {
      color: #1E66B4;
      font-size: 16pt;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #1E66B4;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border: 1px solid #ddd;
    }
    
    th {
      background: #1E66B4;
      color: white;
      padding: 12px;
      text-align: left;
      font-size: 11pt;
    }
    
    th.right {
      text-align: right;
    }
    
    th.center {
      text-align: center;
    }
    
    td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 10pt;
    }
    
    td.right {
      text-align: right;
    }
    
    td.center {
      text-align: center;
    }
    
    .section-total {
      background: #f0f7ff;
      font-weight: bold;
      color: #1E66B4;
    }
    
    .footer {
      margin-top: 40px;
      text-align: center;
      font-size: 10pt;
      color: #666;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    
    #status {
      padding: 10px;
      margin-bottom: 10px;
      background: #fffbdd;
      border: 1px solid #ffd24d;
      border-radius: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="status">Loading portfolio...</div>
  
  <div class="controls">
    <button id="backBtn" class="btn btn-back">← Back to Edit</button>
    <button id="generateBtn" class="btn btn-generate">Generate & Download PDF</button>
  </div>

  <div class="preview-container" id="preview">
    <!-- Content will be loaded here -->
  </div>

  <script type="module">
    const urlParams = new URLSearchParams(window.location.search);
    const portfolioId = urlParams.get('id');
    const status = document.getElementById('status');
    
    function setStatus(msg, isError = false) {
      status.textContent = msg;
      status.style.background = isError ? '#ffecec' : '#fffbdd';
    }
    
    function fmt(num) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
    }
    
    async function loadPortfolio() {
      try {
        if (!portfolioId) {
          throw new Error('No portfolio ID provided');
        }
        
        const res = await fetch(`/api/portfolios/${portfolioId}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load portfolio');
        
        const portfolio = await res.json();
        const loans = JSON.parse(portfolio.loansData || '[]');
        
        // Separate current and paid off loans
        const currentLoans = loans.filter(l => l.status !== 'Paid Off');
        const paidOffLoans = loans.filter(l => l.status === 'Paid Off');
        
        // Calculate totals
        const currentTotal = currentLoans.reduce((sum, l) => sum + (parseFloat(l.balance) || 0), 0);
        const currentInterest = currentLoans.reduce((sum, l) => sum + (parseFloat(l.interestPaid) || 0), 0);
        const paidOffTotal = paidOffLoans.reduce((sum, l) => sum + (parseFloat(l.balance) || 0), 0);
        const paidOffInterest = paidOffLoans.reduce((sum, l) => sum + (parseFloat(l.interestPaid) || 0), 0);
        
        // Generate loan rows
        const generateRows = (loanList) => loanList.map(loan => `
          <tr>
            <td>${loan.address}</td>
            <td class="right">${fmt(loan.balance)}</td>
            <td class="right">${fmt(loan.interestPaid)}</td>
            <td class="center">${loan.status}</td>
          </tr>
        `).join('');
        
        // Build preview HTML
        const html = `
          <div class="header">
            <img src="/preview/assets/Safeguard_Logo_Cropped.png" class="logo" alt="Safeguard">
            <h1>Portfolio Review</h1>
            <div class="investor-name">${portfolio.investorName}</div>
          </div>

          <div class="summary">
            <h2>Summary</h2>
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Current Investment</div>
                <div class="summary-value">${fmt(portfolio.currentInvestmentTotal)}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Lifetime Investment</div>
                <div class="summary-value">${fmt(portfolio.lifetimeInvestmentTotal)}</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Lifetime Interest Paid</div>
                <div class="summary-value">${fmt(portfolio.lifetimeInterestPaid)}</div>
              </div>
            </div>
          </div>

          ${currentLoans.length > 0 ? `
          <div class="section">
            <h2>Current Investments (${currentLoans.length} Loans)</h2>
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th class="right">Principal Balance</th>
                  <th class="right">Interest Paid</th>
                  <th class="center">Status</th>
                </tr>
              </thead>
              <tbody>
                ${generateRows(currentLoans)}
                <tr class="section-total">
                  <td><strong>Current Investment Total</strong></td>
                  <td class="right"><strong>${fmt(currentTotal)}</strong></td>
                  <td class="right"><strong>${fmt(currentInterest)}</strong></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
          ` : ''}

          ${paidOffLoans.length > 0 ? `
          <div class="section">
            <h2>Paid Off and Closed (${paidOffLoans.length} Loans)</h2>
            <table>
              <thead>
                <tr>
                  <th>Address</th>
                  <th class="right">Principal Balance</th>
                  <th class="right">Interest Paid</th>
                  <th class="center">Status</th>
                </tr>
              </thead>
              <tbody>
                ${generateRows(paidOffLoans)}
                <tr class="section-total">
                  <td><strong>Paid Off Total</strong></td>
                  <td class="right"><strong>${fmt(paidOffTotal)}</strong></td>
                  <td class="right"><strong>${fmt(paidOffInterest)}</strong></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
          ` : ''}

          <div class="footer">
            Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
          </div>
        `;
        
        document.getElementById('preview').innerHTML = html;
        setStatus('Preview ready');
      } catch (err) {
        console.error('Error loading portfolio:', err);
        setStatus('Failed to load portfolio: ' + err.message, true);
      }
    }
    
    // Back button
    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.href = `/portfolio-form.html?id=${portfolioId}`;
    });
    
    // Generate PDF button
    document.getElementById('generateBtn').addEventListener('click', async () => {
      setStatus('Generating PDF...');
      console.log('Requesting PDF for portfolio:', portfolioId);
      
      try {
        const res = await fetch(`/api/generate-portfolio-pdf/${portfolioId}`, { 
          method: 'POST',
          credentials: 'include'
        });
        console.log('Response received:', res.status, res.statusText);
        console.log('Content-Type:', res.headers.get('content-type'));
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Server error response:', errorText);
          throw new Error(errorText || 'Failed to generate PDF');
        }
        
        const blob = await res.blob();
        console.log('Blob details:', {
          type: blob.type,
          size: blob.size,
          sizeKB: (blob.size / 1024).toFixed(2) + ' KB'
        });
        
        if (blob.size === 0) {
          throw new Error('PDF is empty (0 bytes)');
        }
        
        if (blob.type && !blob.type.includes('pdf')) {
          console.warn('Warning: blob type is', blob.type, 'not application/pdf');
        }
        
        // Create download link
        const investorName = document.querySelector('.investor-name').textContent;
        const filename = `Portfolio-Review-${investorName.replace(/\s+/g, '-')}.pdf`;
        console.log('Creating download for:', filename);
        
        // Use object URL for download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        
        document.body.appendChild(a);
        console.log('Triggering download...');
        a.click();
        
        // Cleanup after a short delay
        setTimeout(() => {
          URL.revokeObjectURL(url);
          document.body.removeChild(a);
          console.log('Download initiated, cleanup complete');
        }, 500);
        
        setStatus('✅ PDF downloaded!');
        setTimeout(() => setStatus('Preview ready'), 2000);
      } catch (err) {
        console.error('PDF generation error:', err);
        console.error('Error stack:', err.stack);
        alert('Failed to generate PDF: ' + err.message);
        setStatus('Failed to generate PDF: ' + err.message, true);
      }
    });
    
    // Load portfolio on page load
    loadPortfolio();
  </script>
</body>
</html>
